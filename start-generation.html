<!DOCTYPE html>
<html>
<head>
    <title>Fragen Generierung starten</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .button { 
            padding: 15px 30px; 
            font-size: 16px; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 10px 5px;
        }
        .button:hover { background: #45a049; }
        .button:disabled { background: #cccccc; cursor: not-allowed; }
        .results { 
            margin-top: 30px; 
            padding: 20px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            border-left: 4px solid #007bff;
        }
        .success { color: #155724; background: #d4edda; border-color: #28a745; }
        .error { color: #721c24; background: #f8d7da; border-color: #dc3545; }
        .progress { 
            background: #e9ecef; 
            border-radius: 4px; 
            overflow: hidden; 
            height: 20px; 
            margin: 15px 0;
        }
        .progress-bar { 
            background: #007bff; 
            height: 100%; 
            transition: width 0.3s ease; 
        }
        pre { 
            background: #ffffff; 
            padding: 15px; 
            border-radius: 5px; 
            overflow-x: auto; 
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <h1>üéØ Fragen-Generierung f√ºr Klassen 1-3</h1>
    <p>Erstellt systematisch 5 Fragen pro Kombination (Klasse √ó Quartal √ó Dom√§ne) = 240 Fragen total</p>
    
    <div style="margin: 30px 0;">
        <button class="button" onclick="testSingleQuestion()">1Ô∏è‚É£ Test Einzelfrage</button>
        <button class="button" onclick="startBatchGeneration()" id="batchBtn">üöÄ Batch-Generierung starten</button>
    </div>
    
    <div class="progress" style="display: none;" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <div id="status" style="font-weight: bold; margin: 20px 0;"></div>
    <div id="results"></div>

    <script>
        const SUPABASE_URL = 'https://fsmgynpdfxkaiiuguqyr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzbWd5bnBkZnhrYWlpdWd1cXlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2OTg4ODYsImV4cCI6MjA2ODI3NDg4Nn0.unk2ST0Wcsw7RJz-BGrCqQpXSgLJQpAQPgJ-ImGCv-Q';

        function updateStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = message;
            statusDiv.className = isError ? 'error' : '';
        }

        function logResult(title, data, isError = false) {
            const resultsDiv = document.getElementById('results');
            const className = isError ? 'results error' : 'results success';
            const timestamp = new Date().toLocaleTimeString();
            
            resultsDiv.innerHTML += `
                <div class="${className}">
                    <h3>${title} (${timestamp})</h3>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }

        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        async function testSingleQuestion() {
            updateStatus('üîç Teste Einzelfrage-Generierung...');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/generate-questions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        grade: 1,
                        quarter: "Q1",
                        domain: "Zahlen & Operationen",
                        count: 1,
                        difficulty: "AFB I"
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    updateStatus('‚úÖ Test erfolgreich! API funktioniert.');
                    logResult('‚úÖ Einzelfrage Test', {
                        generated: result.generated,
                        requested: result.requested,
                        status: 'success'
                    });
                } else {
                    updateStatus('‚ùå Test fehlgeschlagen!', true);
                    logResult('‚ùå Einzelfrage Test Fehler', {
                        status: response.status,
                        error: result.error || result,
                        response: result
                    }, true);
                }
                
            } catch (error) {
                updateStatus('‚ùå Netzwerkfehler beim Test!', true);
                logResult('‚ùå Test Netzwerkfehler', {
                    error: error.message,
                    stack: error.stack
                }, true);
            }
        }

        async function startBatchGeneration() {
            const batchBtn = document.getElementById('batchBtn');
            batchBtn.disabled = true;
            batchBtn.textContent = '‚è≥ Generiere...';
            
            showProgress();
            updateProgress(0);
            updateStatus('üöÄ Starte Batch-Generierung f√ºr 240 Fragen...');

            try {
                const startTime = Date.now();
                
                const response = await fetch(`${SUPABASE_URL}/functions/v1/batch-generate-questions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                
                updateProgress(100);
                
                if (result.success) {
                    updateStatus(`‚úÖ Batch-Generierung abgeschlossen in ${duration}s!`);
                    logResult('üéâ Batch-Generierung Erfolgreich', {
                        totalGenerated: result.totalGenerated,
                        totalErrors: result.totalErrors,
                        totalCombinations: result.totalCombinations,
                        questionsPerCombination: result.questionsPerCombination,
                        duration: duration + 's',
                        successRate: ((result.totalGenerated / (result.totalCombinations * result.questionsPerCombination)) * 100).toFixed(1) + '%'
                    });
                    
                    // Detailierte Ergebnisse
                    if (result.results) {
                        const successful = result.results.filter(r => r.status === 'success');
                        const failed = result.results.filter(r => r.status === 'error');
                        
                        if (successful.length > 0) {
                            logResult(`‚úÖ Erfolgreiche Generierungen (${successful.length})`, 
                                successful.slice(0, 10) // Zeige nur die ersten 10
                            );
                        }
                        
                        if (failed.length > 0) {
                            logResult(`‚ùå Fehlgeschlagene Generierungen (${failed.length})`, 
                                failed.slice(0, 5), // Zeige nur die ersten 5 Fehler
                                true
                            );
                        }
                    }
                } else {
                    updateStatus('‚ùå Batch-Generierung fehlgeschlagen!', true);
                    logResult('‚ùå Batch-Generierung Fehler', {
                        error: result.error,
                        duration: duration + 's'
                    }, true);
                }
                
            } catch (error) {
                updateStatus('‚ùå Schwerer Fehler bei Batch-Generierung!', true);
                logResult('‚ùå Batch-Generierung Schwerer Fehler', {
                    error: error.message,
                    stack: error.stack
                }, true);
            } finally {
                batchBtn.disabled = false;
                batchBtn.textContent = 'üöÄ Batch-Generierung starten';
                setTimeout(() => hideProgress(), 2000);
            }
        }

        // Auto-test auf Seiten-Load
        window.addEventListener('load', () => {
            updateStatus('Bereit f√ºr Fragen-Generierung');
        });
    </script>
</body>
</html>