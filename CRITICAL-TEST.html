<!DOCTYPE html>
<html>
<head>
    <title>üö® CRITICAL FUNCTION TEST</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #ff6b6b; color: white; }
        .container { background: white; color: black; padding: 20px; border-radius: 10px; }
        .test { margin: 15px 0; padding: 15px; border-radius: 8px; }
        .success { background: #d4edda; border: 2px solid #28a745; }
        .error { background: #f8d7da; border: 2px solid #dc3545; }
        .loading { background: #fff3cd; border: 2px solid #ffc107; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { padding: 15px 25px; font-size: 18px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 10px; }
        .critical { background: #721c24; color: white; padding: 20px; border-radius: 8px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="critical">
        <h1>üö® CRITICAL SYSTEM TEST</h1>
        <p><strong>TESTING EDGE FUNCTIONS IMMEDIATELY</strong></p>
    </div>
    
    <div class="container">
        <button onclick="testAPI()">üß™ TEST BASIC FUNCTION</button>
        <button onclick="testGenerateQuestions()">‚ö° TEST GENERATE QUESTIONS</button>
        <button onclick="testBatch()">üöÄ TEST BATCH</button>
        <button onclick="clearTests()">üóëÔ∏è CLEAR</button>
        
        <div id="results"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://fsmgynpdfxkaiiuguqyr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzbWd5bnBkZnhrYWlpdWd1cXlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2OTg4ODYsImV4cCI6MjA2ODI3NDg4Nn0.unk2ST0Wcsw7RJz-BGrCqQpAQPgJ-ImGCv-Q';

        function addTest(title, content, type) {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `<h3>${title}</h3><pre>${typeof content === 'object' ? JSON.stringify(content, null, 2) : content}</pre>`;
            document.getElementById('results').insertBefore(div, document.getElementById('results').firstChild);
            return div;
        }

        async function testAPI() {
            const test = addTest('üß™ Testing Basic Function', 'Calling test-api function...', 'loading');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/test-api`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ test: true })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                test.className = 'test success';
                test.innerHTML = `<h3>‚úÖ BASIC FUNCTION WORKS!</h3><pre>${JSON.stringify(result, null, 2)}</pre>`;

                if (result.environment?.openaiKeyPresent) {
                    addTest('üîë OpenAI Key Found', 'OpenAI API key is configured!', 'success');
                } else {
                    addTest('‚ùå OpenAI Key Missing', 'OpenAI API key is NOT configured!', 'error');
                }

            } catch (error) {
                test.className = 'test error';
                test.innerHTML = `<h3>üí• BASIC FUNCTION FAILED!</h3><pre>${error.message}</pre>`;
            }
        }

        async function testGenerateQuestions() {
            const test = addTest('‚ö° Testing Generate Questions', 'Calling generate-questions function...', 'loading');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/generate-questions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        grade: 1,
                        quarter: 'Q1',
                        domain: 'Zahlen & Operationen',
                        count: 1,
                        difficulty: 'AFB I'
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                test.className = `test ${result.success ? 'success' : 'error'}`;
                test.innerHTML = `<h3>${result.success ? '‚úÖ GENERATE QUESTIONS WORKS!' : '‚ùå GENERATE QUESTIONS FAILED!'}</h3><pre>${JSON.stringify(result, null, 2)}</pre>`;

            } catch (error) {
                test.className = 'test error';
                test.innerHTML = `<h3>üí• GENERATE QUESTIONS FAILED!</h3><pre>${error.message}</pre>`;
            }
        }

        async function testBatch() {
            const test = addTest('üöÄ Testing Batch Generation', 'Calling batch-generate-questions function...', 'loading');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/batch-generate-questions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                test.className = `test ${result.success ? 'success' : 'error'}`;
                test.innerHTML = `<h3>${result.success ? '‚úÖ BATCH GENERATION WORKS!' : '‚ùå BATCH GENERATION FAILED!'}</h3><pre>${JSON.stringify(result, null, 2)}</pre>`;

            } catch (error) {
                test.className = 'test error';
                test.innerHTML = `<h3>üí• BATCH GENERATION FAILED!</h3><pre>${error.message}</pre>`;
            }
        }

        function clearTests() {
            document.getElementById('results').innerHTML = '';
        }

        // Auto-start basic test
        window.onload = function() {
            addTest('üîÑ System Ready', 'Starting critical tests...', 'loading');
            setTimeout(testAPI, 1000);
        };
    </script>
</body>
</html>