<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ API Functionality Test</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .button { background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; margin: 5px; }
        .button:hover { background: #2563eb; }
        .button:disabled { background: #94a3b8; cursor: not-allowed; }
        .success { color: #059669; }
        .error { color: #dc2626; }
        .warning { color: #d97706; }
        .pre { background: #f8fafc; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; overflow-x: auto; }
        .status { padding: 8px 12px; border-radius: 6px; font-weight: 500; display: inline-block; margin: 5px 0; }
        .status.success { background: #dcfce7; color: #166534; }
        .status.error { background: #fecaca; color: #991b1b; }
        .status.warning { background: #fef3c7; color: #92400e; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ AI API Funktionalit√§tstest</h1>
        <p>Teste systematisch alle AI-APIs und generiere 100 hochwertige Fragen</p>

        <div class="grid">
            <!-- API Connection Tests -->
            <div class="card">
                <h2>üîó API Verbindungstest</h2>
                <button class="button" onclick="testAPIConnections()">APIs Testen</button>
                <div id="apiResults"></div>
            </div>

            <!-- Question Generation Tests -->
            <div class="card">
                <h2>üìù Fragen Generierung</h2>
                <div>
                    <button class="button" onclick="testSingleQuestion()">1 Testfrage (OpenAI)</button>
                    <button class="button" onclick="testSingleQuestionGemini()">1 Testfrage (Gemini)</button>
                    <button class="button" onclick="generateBatch100()">üéØ 100 Fragen Batch</button>
                </div>
                <div id="generationResults"></div>
            </div>
        </div>

        <!-- Database Status -->
        <div class="card">
            <h2>üìä Datenbank Status</h2>
            <button class="button" onclick="checkDatabaseStatus()">DB Status Pr√ºfen</button>
            <div id="dbResults"></div>
        </div>

        <!-- Full Test Results -->
        <div class="card">
            <h2>üéØ Vollst√§ndiger Test</h2>
            <button class="button" onclick="runFullTest()">Kompletter AI-Test durchf√ºhren</button>
            <div id="fullTestResults"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://fsmgynpdfxkaiiuguqyr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzbWd5bnBkZnhrYWlpdWd1cXlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2OTg4ODYsImV4cCI6MjA2ODI3NDg4Nn0.unk2ST0Wcsw7RJz-BGrCqQpXSgLJQpAQPgJ-ImGCv-Q';

        function logResult(containerId, message, data = null, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'success' ? 'success' : type === 'error' ? 'error' : 'warning';
            
            const html = `
                <div class="status ${statusClass}">${timestamp} - ${message}</div>
                ${data ? `<div class="pre">${JSON.stringify(data, null, 2)}</div>` : ''}
            `;
            container.innerHTML += html;
            container.scrollTop = container.scrollHeight;
        }

        async function testAPIConnections() {
            logResult('apiResults', 'üîç Teste API Verbindungen...', null, 'info');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/test-openai-connection`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();
                
                if (response.ok) {
                    logResult('apiResults', '‚úÖ API Test erfolgreich', data, 'success');
                    
                    // Evaluate results
                    const openAIWorking = data.openAI?.success;
                    const geminiWorking = data.gemini?.success;
                    
                    if (openAIWorking && geminiWorking) {
                        logResult('apiResults', 'üéâ Beide APIs funktionieren!', null, 'success');
                    } else if (openAIWorking) {
                        logResult('apiResults', '‚ö†Ô∏è Nur OpenAI funktioniert', null, 'warning');
                    } else if (geminiWorking) {
                        logResult('apiResults', '‚ö†Ô∏è Nur Gemini funktioniert', null, 'warning');
                    } else {
                        logResult('apiResults', '‚ùå Keine API funktioniert!', null, 'error');
                    }
                } else {
                    logResult('apiResults', '‚ùå API Test fehlgeschlagen', data, 'error');
                }
            } catch (error) {
                logResult('apiResults', '‚ùå API Test Fehler', { error: error.message }, 'error');
            }
        }

        async function testSingleQuestion() {
            logResult('generationResults', 'üîÑ Generiere Testfrage mit OpenAI...', null, 'info');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/generate-questions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        grade: 2,
                        quarter: 'Q1',
                        domain: 'Zahlen & Operationen',
                        count: 1
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    logResult('generationResults', '‚úÖ OpenAI Testfrage erfolgreich generiert', data, 'success');
                } else {
                    logResult('generationResults', '‚ùå OpenAI Testfrage fehlgeschlagen', data, 'error');
                }
            } catch (error) {
                logResult('generationResults', '‚ùå OpenAI Testfrage Fehler', { error: error.message }, 'error');
            }
        }

        async function testSingleQuestionGemini() {
            logResult('generationResults', 'üîÑ Teste Gemini √ºber Batch Generator...', null, 'info');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/batch-question-generator`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        totalQuestions: 1,
                        provider: 'gemini'
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    logResult('generationResults', '‚úÖ Gemini Testfrage erfolgreich generiert', data, 'success');
                } else {
                    logResult('generationResults', '‚ùå Gemini Testfrage fehlgeschlagen', data, 'error');
                }
            } catch (error) {
                logResult('generationResults', '‚ùå Gemini Testfrage Fehler', { error: error.message }, 'error');
            }
        }

        async function generateBatch100() {
            logResult('generationResults', 'üöÄ Starte Generierung von 100 Fragen...', null, 'info');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/batch-question-generator`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        totalQuestions: 100,
                        provider: 'mixed'  // Beide APIs nutzen
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    logResult('generationResults', '‚úÖ 100 Fragen Batch erfolgreich!', {
                        summary: data.summary,
                        qualityReport: data.qualityReport
                    }, 'success');
                } else {
                    logResult('generationResults', '‚ùå 100 Fragen Batch fehlgeschlagen', data, 'error');
                }
            } catch (error) {
                logResult('generationResults', '‚ùå 100 Fragen Batch Fehler', { error: error.message }, 'error');
            }
        }

        async function checkDatabaseStatus() {
            logResult('dbResults', 'üìä Pr√ºfe Datenbank Status...', null, 'info');
            
            try {
                // Get template counts by status
                const response = await fetch(`${SUPABASE_URL}/rest/v1/templates?select=status,created_at,grade,domain&order=created_at.desc&limit=1000`, {
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    }
                });

                const templates = await response.json();
                
                const stats = {
                    total: templates.length,
                    active: templates.filter(t => t.status === 'ACTIVE').length,
                    archived: templates.filter(t => t.status === 'ARCHIVED').length,
                    recent: templates.filter(t => new Date(t.created_at) > new Date(Date.now() - 24*60*60*1000)).length,
                    byGrade: {},
                    byDomain: {}
                };

                templates.forEach(t => {
                    stats.byGrade[t.grade] = (stats.byGrade[t.grade] || 0) + 1;
                    stats.byDomain[t.domain] = (stats.byDomain[t.domain] || 0) + 1;
                });

                logResult('dbResults', '‚úÖ Datenbank Status', stats, 'success');
                
                if (stats.active === 0) {
                    logResult('dbResults', '‚ö†Ô∏è KRITISCH: Keine aktiven Templates!', null, 'error');
                } else if (stats.active < 50) {
                    logResult('dbResults', '‚ö†Ô∏è Wenige aktive Templates', { active: stats.active }, 'warning');
                } else {
                    logResult('dbResults', '‚úÖ Ausreichend aktive Templates', { active: stats.active }, 'success');
                }
                
            } catch (error) {
                logResult('dbResults', '‚ùå DB Status Fehler', { error: error.message }, 'error');
            }
        }

        async function runFullTest() {
            logResult('fullTestResults', 'üéØ Starte vollst√§ndigen AI-Funktionalit√§tstest...', null, 'info');
            
            // 1. API Connections Test
            await testAPIConnections();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 2. Database Status Check
            await checkDatabaseStatus();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 3. Single Question Tests
            await testSingleQuestion();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            await testSingleQuestionGemini();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // 4. Final Status Check
            logResult('fullTestResults', 'üîç Finale √úberpr√ºfung...', null, 'info');
            await checkDatabaseStatus();
            
            logResult('fullTestResults', '‚úÖ Vollst√§ndiger Test abgeschlossen!', null, 'success');
        }
    </script>
</body>
</html>